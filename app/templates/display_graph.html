<head>
  <style> body { margin: 0; } </style>
  <script src="//unpkg.com/three"></script>
  <script src="//unpkg.com/three-spritetext"></script>
  <script src="//unpkg.com/3d-force-graph"></script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>
  <div id="3d-graph"></div>

  <script>
    const elem = document.getElementById('3d-graph');

    //Graph data generated in python
    var g_data = {{ force_g_data | tojson | safe }};
    g_data = JSON.parse(g_data);
    g_data.links.forEach(link => {
      const a = g_data.nodes[link.source];
      const b = g_data.nodes[link.target];
      !a.neighbors && (a.neighbors = []);
      !b.neighbors && (b.neighbors = []);
      a.neighbors.push(b);
      b.neighbors.push(a);

      !a.links && (a.links = []);
      !b.links && (b.links = []);
      a.links.push(link);
      b.links.push(link);
    });


    const home_url = 'https://en.wikipedia.org/wiki/';


    const highlightNodes_from_node = new Set();
    const highlightLinks_from_node = new Set();
    const highlightNodes_from_link = new Set();
    const highlightLinks_from_link = new Set();
    let rightClickNode = null;


    const im_url_prefix = 'https://commons.wikimedia.org/wiki/Special:FilePath/';
    const Graph = ForceGraph3D({controlType: 'fly'})
      (elem)
        .graphData(g_data)
        .nodeLabel('id')
        .nodeColor(node => highlightNodes_from_link.has(node) ||  highlightNodes_from_node.has(node) ?
                node === rightClickNode ? 'rgb(255,0,0,1)' : 'rgba(255,0,0,1)' : node.color)
        // .linkColor(link => link === highlightLink ? 'rgba(254,0,14,1)' : 'rgba(244,255,248,0.3)')
        .linkWidth(link => highlightLinks_from_node.has(link) || highlightLinks_from_link.has(link) ? 2 : .001)
        .linkVisibility(link => highlightLinks_from_node.has(link) || highlightLinks_from_link.has(link))
        .linkDirectionalParticles(link => highlightLinks_from_link.has(link) || highlightLinks_from_node.has(link) ? 1.5 : 0)
        .linkDirectionalParticleWidth(4)
        .nodeThreeObjectExtend(true)
        .nodeThreeObject(node => {
              const obj = new THREE.Mesh();
              // add text sprite as child
              var sprite = new SpriteText(node.title);
              sprite.color = node.color;
              sprite.center.set(.5, -.8);
              obj.add(sprite);

              const area_thresh = 9e6;

              if (node.pageimage.source && node.pageimage.width * node.pageimage.height < area_thresh) {
                const imgTexture = new THREE.TextureLoader().load(node.pageimage.source);
                const material = new THREE.SpriteMaterial({map: imgTexture});
                sprite = new THREE.Sprite(material);
                var new_h = 40;
                var new_w = node.pageimage.width / node.pageimage.height * new_h;
                sprite.scale.set(new_w, new_h);
                sprite.center.set(.5, 1.2);
                obj.add(sprite);
              }
              return obj})
        .nodeLabel(node => label(node))
        .onNodeClick(node => {
          highlightNodes_from_node.clear();
          highlightLinks_from_node.clear();
          if ((!node && !highlightNodes.size) || (node && rightClickNode === node)) {
            rightClickNode = null;
            updateHighlight();
            return;
          }

          if (node) {
            highlightNodes_from_node.add(node);
            node.neighbors.forEach(neighbor => highlightNodes_from_node.add(neighbor));
            node.links.forEach(link => highlightLinks_from_node.add(link));
          }

          rightClickNode = node || null;

          updateHighlight();
        })
        .onNodeRightClick(node => {
           window.open(
              home_url + node.title, "_blank");
        });

    // Spread nodes a little wider
    Graph.d3Force('charge').strength(-680);
    Graph.d3Force('link').distance(400);


    function updateHighlight() {
      // trigger update of highlighted objects in scene
      Graph
        .nodeColor(Graph.nodeColor())
        .linkWidth(Graph.linkWidth())
        .linkDirectionalParticles(Graph.linkDirectionalParticles());

    }


    function label(node) {
          var w = 900;
          var h = 700;
          var url = home_url + node.title;
          return '<iframe style="visibility:hidden;" onload="this.style.visibility = \'visible\';" src="' +
                  url + '" width="' + w + '" height="' + h + '">';
    }
  </script>
</body>