<head>
  <style> body { margin: 0; } </style>
  <script src="//unpkg.com/three"></script>
  <script src="//unpkg.com/three-spritetext"></script>
  <script src="//unpkg.com/3d-force-graph"></script>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>

<body>
  <div id="3d-graph"></div>

  <script>
    const elem = document.getElementById('3d-graph');

    var json_data = {{ force_g_data | tojson | safe }};
    json_data = JSON.parse(json_data);
    const home_url = 'https://en.wikipedia.org/wiki/';

    let highlightNodes = [];
    let highlightLink = null;

    const Graph = ForceGraph3D({controlType: 'fly'})
      (elem)
        .graphData(json_data)
        .nodeLabel('id')
        .linkColor(link => link === highlightLink ? 'rgba(254,0,14,1)' : 'rgba(244,255,248,0.3)')
        .nodeAutoColorBy('group')
        .linkWidth(link => link === highlightLink ? 4 : .3)
        .linkDirectionalParticles(link => link === highlightLink ? 4 : 0)
        .linkDirectionalParticleWidth(4)
        .nodeThreeObject(node => {
              const obj = new THREE.Mesh(
                new THREE.SphereGeometry(15),
                new THREE.MeshBasicMaterial({ depthWrite: false, transparent: true, opacity: .1 })
              );
              // add text sprite as child
              const sprite = new SpriteText(node.id);
              sprite.color = node.color;
              // sprite.textHeight = 8;
              obj.add(sprite);
              return obj})
        .nodeLabel(node => {
          return label(node);
        })
        .onLinkHover(link => {
          // no state change
          if (highlightLink === link) return;

          highlightLink = link;
          highlightNodes = link ? [link.source, link.target] : [];

          updateHighlight();
        })


        .onNodeClick(node => {
           window.open(
              home_url + node.id, "_blank");
        });
        // console.log(Graph.renderer().state);
        // Spread nodes a little wider
        Graph.d3Force('charge').strength(-250);
        Graph.d3Force('link').distance(500);


        function updateHighlight() {
          // trigger update of highlighted objects in scene
          Graph
            // .nodeColor(Graph.nodeColor())
            .linkWidth(Graph.linkWidth())
            .linkDirectionalParticles(Graph.linkDirectionalParticles())
            .linkColor(Graph.linkColor());

        }


    function label(node) {
          var w = 900;
          var h = 700;
          var url = home_url + node.id;
          return '<iframe style="visibility:hidden;" onload="this.style.visibility = \'visible\';" src="' +
                  url + '" width="' + w + '" height="' + h + '">';
    }
  </script>
</body>